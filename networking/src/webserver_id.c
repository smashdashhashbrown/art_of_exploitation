#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <sys/socket.h>
#include <netinet/in.h>
#include <arpa/inet.h>
#include <netdb.h>
#include "../include/hacking.h"
#include "../include/hacking-network.h"

int main(int argc, char const *argv[])
{
	int sockfd;
	struct hostent *host_info;
	struct sockaddr_in tgt_addr = {0};
	char buffer[4096];

	if (argc != 2) {
		printf("Usage: %s <hostname>\n", argv[0]);
		return EXIT_FAILURE;
	}

	host_info = gethostbyname(argv[1]);
	if (host_info == NULL) {
		perror("Failed to resolve hostname.\n");
		return EXIT_FAILURE;
	}

	sockfd = socket(AF_INET, SOCK_STREAM, 0);
	if (sockfd == -1) {
		perror("Failed to create socket.\n");
		return EXIT_FAILURE;
	}

	tgt_addr.sin_family = AF_INET;
	tgt_addr.sin_port = htons(80);
	tgt_addr.sin_addr = *((struct in_addr *)host_info->h_addr);

	if (connect(sockfd, (struct sockaddr *)&tgt_addr, sizeof(struct sockaddr)) == -1) {
		printf("Failed to create connection to %s.\n", inet_ntoa(tgt_addr.sin_addr));
		return EXIT_FAILURE;
	}

	send_string(sockfd, "HEAD / HTTP/1.0\r\n\r\n");

	while (recv_line(sockfd, buffer)) {
		if (strncasecmp(buffer, "Server:", 7) == 0) {
			printf("The web server for %s is %s\n", argv[1], buffer+8);
			return EXIT_SUCCESS;
		}
	}
	printf("Filed to find server line.\n");
	return EXIT_FAILURE;
}