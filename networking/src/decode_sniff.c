#include <pcap.h>
#include <stdlib.h>
#include <string.h>
#include <sys/socket.h>
#include <netinet/in.h>
#include <arpa/inet.h>
#include "../include/hacking.h"
#include "../include/hacking-network.h"

#define MAX_PKT_LEN 4096

void pcap_fatal(const char *, const char *);
void decode_ethernet(const u_char *);
void decode_ip(const u_char *);
u_int decode_tcp(const u_char *);

void caught_packet(u_char *, const struct pcap_pkthdr *, const u_char *);

int main() {
	char errbuf[PCAP_ERRBUF_SIZE];
	pcap_if_t *all_devices;
	char *device;
	pcap_t *pcap_handle;

	pcap_findalldevs(&all_devices, errbuf);
	if (all_devices == NULL) {
		pcap_fatal("pcap_findalldevs", errbuf);
	}

	device = all_devices->name;
	printf("Sniffing on interface: %s\n", device);

	pcap_handle = pcap_open_live(device, MAX_PKT_LEN, 1, 0, errbuf);
	if (pcap_handle == NULL) {
		pcap_fatal("pcap_open_live", errbuf);
	}

	pcap_loop(pcap_handle, 1000, caught_packet, NULL);

	pcap_freealldevs(all_devices);
	pcap_close(pcap_handle);

	return EXIT_SUCCESS;
}

void caught_packet(u_char *user_args,
				   const struct pcap_pkthdr *cap_header,
				   const u_char *packet) {
	int tcp_header_len;
	int total_header_size;
	int pkt_data_len;
	u_char *pkt_data;

	printf("==== Captured a %dB packet ====\n", cap_header->len);

	decode_ethernet(packet);
	decode_ip(packet + ETHER_HDR_LEN);
	tcp_header_len = decode_tcp(packet + ETHER_HDR_LEN + IP_HDR_LEN);

	total_header_size = ETHER_HDR_LEN + IP_HDR_LEN + tcp_header_len;	
	pkt_data = (u_char *)packet + total_header_size;
	pkt_data_len = (cap_header->len) - total_header_size;

	if (pkt_data_len > 0) {
		printf("\t\t\t %uB of packet data\n", pkt_data_len);
		dump(pkt_data, pkt_data_len);
	} else {
		printf("\t\t\tNo packet data\n");
	}
	printf("==== Packet end ====\n");
}

void pcap_fatal(const char *failed_in, const char *errbuf) {
	printf("Fatal error in %s: %s\n", failed_in, errbuf);
	exit(EXIT_FAILURE);
}

void decode_ethernet(const u_char *header) {
	const ether_hdr_t *eth_hdr;
	eth_hdr = (const ether_hdr_t *) header;

	printf("[[  Layer 2 :: Ethernet Header  ]]\n");
	printf("[ Source: %02x", eth_hdr->ether_src_addr[0]);
	for (int i = 1; i < ETHER_ADDR_LEN; i++) {
		printf(":%02x", eth_hdr->ether_src_addr[i]);
	}
	printf("\tDest: %02x", eth_hdr->ether_dest_addr[0]);
	for (int i = 1; i < ETHER_ADDR_LEN; i++) {
		printf(":%02x", eth_hdr->ether_dest_addr[i]);
	}
	printf("\tType: %hu ]\n", eth_hdr->ether_type);
}

void decode_ip(const u_char *header) {
	const ip_hdr_t *ip_hdr;
	ip_hdr = (const ip_hdr_t *) header;

	struct in_addr ip_addr = {0};

	printf("\t((  Layer 3 ::: IP Header  ))\n");
	ip_addr.s_addr = ip_hdr->ip_src_addr;
	printf("\t( Source: %s", inet_ntoa(ip_addr));
	ip_addr.s_addr = ip_hdr->ip_dst_addr;
	printf("\tDest: %s )\n", inet_ntoa(ip_addr));
	printf("\t( Type: %u", ip_hdr->ip_type);
	printf("\tID: %hu\tLength: %hu )\n", ntohs(ip_hdr->ip_id),
										 ntohs(ip_hdr->ip_len));
}

u_int decode_tcp(const u_char *header) {
	u_int header_size;
	const tcp_hdr_t *tcp_hdr;

	tcp_hdr = (const tcp_hdr_t *) header;
	header_size = 4 * tcp_hdr->tcp_offset;

	printf("\t\t{  Layer 4 :::: TCP Header  }\n");
	printf("\t\t{ Src Port: %hu", ntohs(tcp_hdr->tcp_src_port));
	printf("\tDest Port: %hu }\n", ntohs(tcp_hdr->tcp_dst_port));
	printf("\t\t{ Seq #: %u", ntohl(tcp_hdr->tcp_seq));
	printf("\tACK #: %u }\n", ntohl(tcp_hdr->tcp_ack));
	printf("\t\t{ Header Size: %u\tFlags: ", header_size);
	if (tcp_hdr->tcp_flags & TCP_FIN)
		printf("FIN ");
	if (tcp_hdr->tcp_flags & TCP_SYN)
		printf("SYN ");
	if (tcp_hdr->tcp_flags & TCP_RST)
		printf("RST ");
	if (tcp_hdr->tcp_flags & TCP_PUSH)
		printf("PUSH ");
	if (tcp_hdr->tcp_flags & TCP_ACK)
		printf("ACK ");
	if (tcp_hdr->tcp_flags & TCP_URG)
		printf("URG ");
	printf("}\n");

	return header_size;
}
