#include <pcap/pcap.h>
#include <stdlib.h>
#include "../include/hacking.h"

void pcap_fatal(const char *failed_in, const char *errbuf) {
	printf("Fatal error in %s: %s\n", failed_in, errbuf);
	exit(EXIT_FAILURE);
}

int main() {
	struct pcap_pkthdr header;
	pcap_if_t *all_devices;
	const u_char *packet;
	char errbuf[PCAP_ERRBUF_SIZE];
	char *device;
	pcap_t *pcap_handle;

	pcap_findalldevs(&all_devices, errbuf);
	if (all_devices == NULL) {
		pcap_fatal("pcap_findalldevs", errbuf);
	}

	device = all_devices->name;
	printf("Sniffing on device: %s\n", device);

	pcap_handle = pcap_open_live(device, 4096, 1, 0, errbuf);
	if (pcap_handle == NULL) {
		pcap_fatal("pcap_open_live", errbuf);
	}
	printf("PCAP handle created.\n");

	for (int i = 0; i < 1000; i++) {
		packet = pcap_next(pcap_handle, &header);
		printf("Captured a %d byte packet.\n", header.len);
		dump(packet, header.len);
	}
	pcap_freealldevs(all_devices);
	pcap_close(pcap_handle);

	return EXIT_SUCCESS;
}
