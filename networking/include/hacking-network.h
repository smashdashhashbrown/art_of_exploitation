#ifndef HACKING_NETWORK
#define HACKING_NETWORK

#define EOL "\r\n"
#define EOL_SIZE 2

#include <stdbool.h>
#include <stdint.h>

#define ETHER_ADDR_LEN 6
#define ETHER_HDR_LEN 14

typedef struct ether_hdr {
	uint8_t ether_dest_addr[ETHER_ADDR_LEN];
	uint8_t ether_src_addr[ETHER_ADDR_LEN];
	uint16_t ether_type;
} ether_hdr_t;

#define IP_HDR_LEN 20

typedef struct ip_hdr {
	uint8_t ip_ver_and_hdr_len;
	uint8_t ip_tos;
	uint16_t ip_len;
	uint16_t ip_id;
	uint16_t ip_frag_offset;
	uint8_t ip_ttl;
	uint8_t ip_type;
	uint16_t ip_checksum;
	uint32_t ip_src_addr;
	uint32_t ip_dst_addr;
} ip_hdr_t;

typedef struct tcp_hdr {
	uint16_t tcp_src_port;
	uint16_t tcp_dst_port;
	uint32_t tcp_seq;
	uint32_t tcp_ack;
	uint8_t reserved:4;
	uint8_t tcp_offset:4;
	uint8_t tcp_flags;
#define TCP_FIN 0x01
#define TCP_SYN 0x02
#define TCP_RST 0x04
#define TCP_PUSH 0x08
#define TCP_ACK 0x10
#define TCP_URG 0x20
	uint16_t tcp_window;
	uint16_t tcp_checksum;
	uint16_t tcp_urgent;
} tcp_hdr_t;

bool send_string(int sockfd, char *buffer) {
	int bytes_sent = 0;
	// @ASSUMPTION buffer null termination
	int bytes_to_send = strlen(buffer);

	while (bytes_to_send > 0) {
		bytes_sent = send(sockfd, buffer, bytes_to_send, 0);
		if (bytes_sent == -1) {
			return false;
		}

		bytes_to_send -= bytes_sent;
		buffer += bytes_sent;
	}
	return true;
}

// Buffer overflow vulnerable
int recv_line(int sockfd, char *dest_buffer) {
	char *ptr;
	int eol_match = 0;

	ptr = dest_buffer;
	while (recv(sockfd, ptr, 1, 0) == 1) {
		if (*ptr == EOL[eol_match]) {
			eol_match++;
			if (eol_match == EOL_SIZE) {
				*(ptr+1-EOL_SIZE) = '\0';
				return strlen(dest_buffer);
			}
		} else {
			eol_match = 0;
		}
		ptr++;
	}
	return 0;
}

#endif